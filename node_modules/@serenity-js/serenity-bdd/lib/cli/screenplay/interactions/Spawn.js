"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Spawn = void 0;
const core_1 = require("@serenity-js/core");
const io_1 = require("@serenity-js/core/lib/io");
const child_process_1 = require("child_process");
const model_1 = require("../../model");
/**
 * @package
 */
class Spawn extends core_1.Interaction {
    static the(pathToExecutable, ...args) {
        return new Spawn(pathToExecutable, args);
    }
    constructor(pathToExecutable, args) {
        super((0, io_1.d) `#actor executes ${pathToExecutable} with ${args}`);
        this.pathToExecutable = pathToExecutable;
        this.args = args;
    }
    /**
     * @desc
     *  Makes the provided {@apilink @serenity-js/core/lib/screenplay/actor~Actor}
     *  perform this {@apilink @serenity-js/core/lib/screenplay~Interaction}.
     *
     * @param {UsesAbilities & AnswersQuestions & CollectsArtifacts} actor
     * @returns {Promise<void>}
     *
     * @see {@apilink @serenity-js/core/lib/screenplay/actor~Actor}
     * @see {@apilink @serenity-js/core/lib/screenplay/actor~UsesAbilities}
     * @see {@apilink @serenity-js/core/lib/screenplay/actor~AnswersQuestions}
     * @see {@apilink @serenity-js/core/lib/screenplay/actor~CollectsArtifacts}
     */
    performAs(actor) {
        return actor.answer(this.pathToExecutable)
            .then(pathToExecutable => new Promise((resolve, reject) => {
            actor.collect(model_1.Notification.fromJSON({ message: `Spawning: ${pathToExecutable.value} ${this.args.join(' ')}` }));
            const spawned = (0, child_process_1.spawn)(pathToExecutable.value, this.args, { stdio: [process.stdin, process.stdout, process.stderr] });
            spawned.once('error', (error) => actor.collect(model_1.Complaint.fromJSON({ description: `Invoking Serenity BDD CLI has failed`, message: error.message, stack: error.stack })));
            spawned.once('exit', (exitCode) => exitCode === 0
                ? resolve(void 0)
                : reject(new model_1.ExecutionError(`The following process exited with ${exitCode}: ${pathToExecutable.value} ${this.args.join(' ')}`)));
        }));
    }
}
exports.Spawn = Spawn;
//# sourceMappingURL=Spawn.js.map